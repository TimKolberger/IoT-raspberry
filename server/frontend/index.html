<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>IoT</title>
		<style type="text/css">
			.chart {
				width: 100%;
				height: 300px;
			}

			#dataarea {
				display: none;
			}

            #actionarea {
                display: flex;
                visibility: hidden;
            }

            .action {
                border:1px solid #CCC;
                margin: 10px;
                padding: 10px;
            }

            #actionlinks a.active {
                color: red;
            }

			a {
				color: blue;
				cursor: pointer;
			}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.0/socket.io.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.0/moment.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.0/locale/de.js"></script>
		<script>
		var backendUrl = 'https://d1303.de:3000';
        var types = ["temperature", "cputemp", "humidity", "light", "soundvol", "sound", "movement1", "movement2"];
		var currentChartData = {};
		var charts = {};
		var socket = null;
        var isLive = true;

		function getClients(cb)
		{
			$.get("/clients/get", function(clients)
			{
				cb(JSON.parse(clients));
			});
		}
		
		function trimTo(arr, num)
		{
			return arr.slice(Math.max(-1 * num, -1 * arr.length));
		}
		
		function generateInitialChartData(labels, data)
		{
			return 	{
				labels: labels,
				datasets: [
				{
					label: "IoT Graph",
					fillColor: "rgba(151,187,205,0.2)",
					strokeColor: "rgba(151,187,205,1)",
					pointColor: "rgba(151,187,205,1)",
					pointStrokeColor: "#fff",
					pointHighlightFill: "#fff",
					pointHighlightStroke: "rgba(151,187,205,1)",
					data: data
				}]
			};
		}

        function plot(type, labels, data)
        {
            var container = document.getElementById("chart-" + type);
            var chartData = generateInitialChartData(labels, data)
            var ctx = container.getContext("2d");
            charts[type] = new Chart(ctx).Line(chartData, { animation: false, responsive: true });
        }

		function renderInitialChart(type)
		{
			socket.emit("ui:full", { type: type }, function(dps)
			{
				var labels = [];
				var data = [];

				for (var i = dps.length - 1; i >= 0; i--)
				{
					var time = moment(dps[i].created).format('dd, HH:mm:ss');
					var dp = dps[i].data;

					labels.push(time);
					data.push(dp);
				}

                plot(type, labels, data);
			});
		}

		function renderHistoryAggregation(query)
		{
            isLive = false;

			socket.emit(query, { }, function(dps)
            {
                resetUi();

                console.log("got it all", dps);

                for (var i = 0; i < types.length; i++)
                {
                    var type = types[i];

                    var datapointsForType = dps[type];
                    var labels = [];
                    var data = [];

                    for (var k = 0; k < datapointsForType.length; k++)
                    {
                        var aggregated = datapointsForType[k];

                        if (aggregated !== null)
                        {
                            var time = "no data";

                            switch (query)
                            {
                                case "ui:lasthour":
                                    time = moment(aggregated.from).format('HH:mm:ss') + " - " + moment(aggregated.to).format('HH:mm:ss');
                                    break;
                                case "ui:hoursofday":
                                    time = moment(aggregated.from).format('HH:mm') + " - " + moment(aggregated.to).format('HH:mm');
                                    break;
                                case "ui:daysofmonth":
                                    time = moment(aggregated.from).format('DD.MM.');
                                    break;
                            }

                            var dp = aggregated.data;
                            labels.push(time);
                            data.push(dp);
                        }
                        else
                        {
                            labels.push("no data");
                            data.push(null);
                        }
                    }

                    plot(type, labels, data);
                }
            });
		}

        function sendAction(type, transferObject)
        {
            var action = {
                type: type,
                data: transferObject
            };

            console.log("emitting action to client", action);

            socket.emit("ui:action", action);
        }

        function resetUi()
        {
            $("#actionarea").css("visibility", "visible");
            $("#dataarea").html("").show();

            types.forEach(function(type)
            {
                if (type in charts) {
                    charts[type].destroy();
                }

                charts = {};

                $("#dataarea")[0].innerHTML += "<h2>" + type + "<canvas id='chart-" + type + "' class='chart'></canvas>";
            });
        }

        function startLiveMode()
        {
            isLive = true;

            resetUi();

            types.forEach(function(type)
            {
                renderInitialChart(type);
            });
        }

		function connectToDevice(id)
		{
			if (socket)
			{
				socket.disconnect();
			}

			socket = io.connect(backendUrl, { query: "mode=ui&client=" + id });

			socket.on("connect", function()
			{
                startLiveMode();
			});

			socket.on("dataupdate", function(msg)
			{
                if (!isLive)
                {
                    return;
                }

				//console.log("received", msg);

				var type = msg.type;
				var data = msg.data;
				var time = moment(msg.created).format('dd, HH:mm:ss');

				if (charts[type])
				{
					charts[type].removeData();
					charts[type].addData([data], time);
				}
			});
		}

		$(document).ready(function()
		{
			$("#connectedClients").on("click", "a", function()
			{
				var id = $(this).attr("data-id");
				connectToDevice(id);
			});

            $("#actionarea").on("click", "input.send", function()
            {
                var type = $(this).parents("div.action").attr("id");
                var transferObject = {};

                if (type === "led")
                {
                    var ledType = $("#led select").val();
                    transferObject.ledType = ledType;
                }
                else if (type === "switchrc")
                {
                    var switchNumber = $("#switchrc select").val();
                    var onoff = $("#switchrc input[name=switchrconoff]:checked").val();

                    transferObject.switchNumber = switchNumber;
                    transferObject.onoff = onoff;
                }

                sendAction(type, transferObject);
            });

            $("a#actionLive").on("click", function()
            {
                $("#actionlinks a").removeClass("active");
                $(this).addClass("active");
                startLiveMode();
            });

            $("a#actionLastHour").on("click", function()
            {
                $("#actionlinks a").removeClass("active");
                $(this).addClass("active");
                renderHistoryAggregation("ui:lasthour");
            });

            $("a#actionHoursOfDay").on("click", function()
            {
                $("#actionlinks a").removeClass("active");
                $(this).addClass("active");
                renderHistoryAggregation("ui:hoursofday");
            });

            $("a#actionDaysOfMonth").on("click", function()
            {
                $("#actionlinks a").removeClass("active");
                $(this).addClass("active");
                renderHistoryAggregation("ui:daysofmonth");
            });

			getClients(function(clients)
			{
				$("#connectedClients").append("<h2>Number of connected clients: " + clients.length + "</h2><ul>");
				
				for (var i = 0; i < clients.length; i++)
				{
					var clientHtml = "<li>" +
										"<a data-id='" + clients[i].id + "' class='connectedClient'>" +
										"<b>" + clients[i].client_name + "</b> " +
										"</a>(" + clients[i].id + " @ " + clients[i].address + ")" +
									"</li>"

					$("#connectedClients").append(clientHtml);
				}

				$("#connectedClients").append("</ul>");
			});
		});
		</script>
	</head>
	<body>
		<h1>IoT-Server</h1>
		<div id="connectedClients"></div>
		<div id="actionarea">
			<div id="switchrc" class="action">
                <h4>RC Switch</h4>

                <p>RC Switch Number
                <select>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                </select></p>

                <p>Turn...
                    <input type="radio" name="switchrconoff" value="0" />off
                    <input type="radio" name="switchrconoff" value="1" checked />on
                </p>

                <p><input type="button" value="send" class="send" /></p>
			</div>
			<div id="led" class="action">
                <h4>Flash LED</h4>
                <p>color
                <select>
                    <option>green</option>
                    <option>red</option>
                </select></p>

               <p><input type="button" value="send" class="send" /></p>
			</div>
            <div id="actionlinks" class="action">
                <h4>Toggle Display Mode</h4>
                <ul>
                    <li><a id="actionLive" class="active">Live</a></li>
                    <li><a id="actionLastHour">Last hour</a></li>
                    <li><a id="actionHoursOfDay">Hours of day</a></li>
                    <li><a id="actionDaysOfMonth">Days of month</a></li>
                </ul>
            </div>
		</div>
		<div id="dataarea"></div>
	</body>
</html>